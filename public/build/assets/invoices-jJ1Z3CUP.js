$(function(){let p=window.dtes,f=window.tiposDte,m=window.receptores_nit,c=new Set,s=window.tienda;$("#invoicesTable tfoot th").each(function(){if($(this).index()<$("#invoicesTable tfoot th").length-1){var o=$(this).text();$(this).html('<input class="form-control form-control-sm" type="text" placeholder="Buscar '+o+'" />')}else $(this).html("")});function b(o){let a=[];return o.forEach(t=>{let e={fh_procesamiento:new Date(t.fh_procesamiento).toLocaleString(),tipo_dte:f[t.tipo_dte],enlace_pdf:t.enlace_pdf,enlace_json:t.enlace_json,enlace_ticket:t.enlace_ticket,cod_generacion:t.cod_generacion,numero_control:t.numero_control,sello_recibido:t.sello_recibido,estado:t.estado,observaciones:t.observaciones};if(t.documento.apendice!=null){const l=t.documento.apendice.find(r=>r.campo==="Tienda");e.tienda=l?l.valor:"",c.add(e.tienda);const u=t.documento.apendice.find(r=>r.campo==="Transaccion");e.transaccion=u?u.valor:""}else e.tienda="",e.transaccion="";let d="",n="",i=null;switch(t.tipo_dte=="14"?i=t.documento.sujetoExcluido:i=t.documento.receptor,i!=null&&(d=i.nombre,t.tipo_dte in m?n=i.nit:n=i.numDocumento),n=n||"",e.receptor=d+"<br>"+n,t.tipo_dte){case"01":e.neto="$"+t.documento.resumen.totalPagar.toFixed(2),e.iva="$"+t.documento.resumen.totalIva.toFixed(2),e.total="$"+t.documento.resumen.totalPagar.toFixed(2);break;case"03":e.neto="$"+t.documento.resumen.subTotalVentas.toFixed(2),e.iva="$"+(t.documento.resumen.totalPagar-t.documento.resumen.subTotalVentas).toFixed(2),e.total="$"+t.documento.resumen.totalPagar.toFixed(2);break;case"05":e.neto="$"+t.documento.resumen.subTotalVentas.toFixed(2),e.iva="$"+(t.documento.resumen.montoTotalOperacion-t.documento.resumen.subTotalVentas).toFixed(2),e.total="$"+t.documento.resumen.montoTotalOperacion.toFixed(2);break;case"07":e.neto="$"+t.documento.resumen.totalSujetoRetencion.toFixed(2),e.iva="$"+t.documento.resumen.totalIVAretenido.toFixed(2),e.total="$"+t.documento.resumen.totalSujetoRetencion.toFixed(2);break;case"11":e.neto="$"+t.documento.resumen.totalPagar.toFixed(2),e.iva="$0.00",e.total="$"+t.documento.resumen.totalPagar.toFixed(2);break;case"14":e.neto="$"+t.documento.resumen.totalCompra.toFixed(2),e.iva="$0.00",e.total="$"+t.documento.resumen.totalCompra.toFixed(2);break;default:e.neto="$0.00",e.iva="$0.00",e.total="$0.00";break}a.push(e)}),g(),s!="ALL"&&s!=""&&(a=a.filter(t=>t.tienda===s)),$("#statisticsTotal").text(a.length),$("#statisticsAnulado").text(a.filter(t=>t.estado==="ANULADO").length),$("#statisticsApproved").text(a.filter(t=>t.estado==="PROCESADO").length),$("#statisticsRejected").text(a.filter(t=>t.estado==="RECHAZADO").length),$("#statisticsContingencia").text(a.filter(t=>t.estado==="CONTINGENCIA").length),a}function g(){c.forEach(o=>{$("#tienda").append(`<option value="${o}" ${o===s?"selected":""}>${o}</option>`)})}$("#invoicesTable").DataTable({initComplete:function(){this.api().columns().every(function(){var o=this;$("input",this.footer()).on("keyup change clear",function(){o.search()!==this.value&&o.search(this.value).draw()})})},data:b(p),language:{lengthMenu:"Mostrar _MENU_ registros por página",zeroRecords:"No se encontraron resultados",info:"Mostrando página _PAGE_ de _PAGES_",infoEmpty:"No hay registros disponibles",infoFiltered:"(filtrado de _MAX_ registros totales)",search:"Buscar:",paginate:{first:"Primero",last:"Último",next:"Siguiente",previous:"Anterior"}},aoColumns:[{data:"fh_procesamiento"},{data:"tienda"},{data:"transaccion"},{data:"receptor"},{data:"neto"},{data:"iva"},{data:"total"},{data:"tipo_dte"},{data:"estado"},{data:"observaciones",render:function(o){return o!="[]"?'<p class="text-break">'+o+"</p>":""}},{data:"cod_generacion"},{data:"numero_control"},{data:"sello_recibido",render:function(o){return'<p class="text-break">'+o+"</p>"}},{data:"estado",render:function(o,a,t){return o!="CONTINGENCIA"&&o!="RECHAZADO"?`<div class="d-inline-flex">
                            <a href="${t.enlace_pdf}"
                                class="btn btn-sm btn-danger ms-1 d-flex align-items-center"
                                target="_blank">PDF</a>
                            <a href="${t.enlace_json}"
                                class="btn btn-sm btn-success ms-1 d-flex align-items-center"
                                target="_blank">JSON</a>
                            <a href="${t.enlace_ticket}"
                                class="btn btn-sm btn-warning ms-1 d-flex align-items-center"
                                target="_blank">Tiquete</a>
                            <button type="button"
                                class="btn btn-primary btn-sm ms-1 btn-modal d-flex align-items-center"
                                data-bs-toggle="modal" data-bs-target="#mailModal"
                                data-id="${t.cod_generacion}">
                                Reenviar Correo
                            </button>
                        </div>`:""}}],createdRow:function(o,a,t){(a.estado=="CONTINGENCIA"||a.estado=="RECHAZADO")&&$(o).addClass("table-danger")},dom:'<"container-fluid"<"row"<"col"l><"col"B><"col"f>>>rtip',buttons:[{extend:"print",text:'<i class="fas fa-print"></i> Imprimir',title:"Reporte de DTEs",className:"btn btn-primary",orientation:"landscape",exportOptions:{columns:[0,1,2,3,4,5,6,7,9,10,11,12]}},{extend:"excel",text:'<i class="fas fa-file-excel"></i> Excel',title:"Reporte de DTEs",className:"btn btn-success",exportOptions:{columns:[0,1,2,3,4,5,6,7,9,10,11,12]}},{extend:"pdf",orientation:"landscape",pageSize:"LEGAL",text:'<i class="fas fa-file-pdf"></i> PDF',title:"Reporte de DTEs",className:"btn btn-danger",exportOptions:{columns:[0,1,2,3,4,5,6,7,9,10,11,12]}}],order:[[0,"desc"]]}),$(".btn-modal").on("click",function(o){var a=$(o.target),t=a.data("id");console.log(t),$("#cod_generacion").val(t)})});
